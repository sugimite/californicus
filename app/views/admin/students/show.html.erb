<% name = @student.name
   @title = "#{name}さん" %>

<h1><%= @title %></h1>

<div class="table-wrapper">
  <div class="links">
    <%= link_to "生徒一覧", :admin_students %>
  </div>

  <table class="attributes">
    <tr>
      <th>名前</th>
      <td>
        <%= @student.name %>
      </td>
      </th>
    </tr>
    <tr>
      <th>フリガナ</th>
      <td>
        <%= @student.name_kana %>
      </td>
    </tr>
    <tr>
      <th>学年</th>
      <td>
        <%= @student.school_grade %>
      </td>
    </tr>
    <tr>
      <th>誕生日</th>
      <td>
        <%= @student.birthday %>
      </td>
    </tr>
    <tr>
      <th>メールアドレス</th>
      <td>
        <%= @student.email %>
      </td>
    </tr>
    <tr>
      <th>入会日</th>
      <td>
        <%= @student.registration_date %>
      </td>
    </tr>
    <tr>
      <th>退会日</th>
      <td>
        <%= @student.cancellation_date %>
      </td>
    </tr>
    <tr>
      <th>スマホ預かり設定</th>
      <td>
        <%= @student.has_deposited_phone ? "設定中" : "未設定" %>
      </td>
    </tr>
    <tr>
      <th>未提出宿題</th>
      <td>
        <% if @homeworks.any? %>
          <% @homeworks.each do |homework| %>
            <p>種類： <%= homework.homework_type %>, ページ： <%= homework.page %></p>
          <% end %>
        <% else %>
          <p>未提出の宿題はありません。</p>
        <% end %>
      </td>
    </tr>
    <tr>
      <th>今年度の宿題忘れ</th>
      <td>
        <%= @student.homework_forgets_in_year(@student.current_school_year) %>回
      </td>
    </tr>
  </table>

  <div class="monthly-forgets">
    <% start_year = 2024 %>
    <% end_year = Date.today.year %>

    <% (start_year..end_year).each do |year| %>
      <h2><%= "#{year}年度 (#{year}/03~#{year +1}/02)" %></h2>

      <div class="yearly-forgets">
        <% months = (3..12).to_a + (1..2).to_a %>
        <% months.each do |month| %>
          <div class="month-column">
            <h3><%= "#{month}月" %></h3>
            <% display_year = year + (month <= 2 ? 1 : 0) %>
            <p><%= @student.homework_forgets_in_month(display_year, month) %>回</p>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>

  <table class="listing">
    <tr>
      <th>日付</th>
      <th>入室時間</th>
      <th>退室時間</th>
      <th>滞在時間</th>
      <th>前回宿題</th>
      <th>宿題</th>
      <th>メモ</th>
    </tr>
  
    <% @attendances_and_absences.each do |date, attendance| %>
      <tr>
        <td><%= date %></td>
        
        <% if attendance %>
          <td><%= attendance.in_at.strftime("%H:%M:%S") %></td>
          <td><%= attendance.out_at&.strftime("%H:%M:%S") %></td>
          <td><%= attendance.staying_time %></td>
          <td>
            <% if attendance.previous_week_homework_submitted? == true %>
              <span class="label label-success">提出済み</span>
            <% elsif attendance.previous_week_homework_submitted? == false %>
              <span class="label label-warning">未提出</span>
            <% else %>
              <span class="label label-default">宿題なし</span>
            <% end %>
          </td>
          <td>
            <% if @homeworks_past[date] %>
              <% @homeworks_past[date].each do |homework| %>
              <p>内容: <%= homework.homework_type %>, 　p: <%= homework.page %></p>
            <% end %>
            <% else %>
              <p>宿題なし</p>
            <% end %>
          </td>
          <td>
            <% if @memos[date] %>
              <% @memos[date].each do |memo| %>
              <p>内容: <%= memo.content %>
            <% end %>
            <% else %>
              <p>特記事項なし</p>
            <% end %>
          </td>
        <% else %>
          <!-- 欠席の日 -->
          <td colspan="6" style="text-align: center; color: red;">欠席</td>
        <% end %>
      </tr>
    <% end %>
  
    <% if @attendances_and_absences.empty? %>
      <tr>
        <%= content_tag(:td, "記録がありません", colspan: 7, style: "text-align: center") %>
      </tr>
    <% end %>
  </table>
</div>
